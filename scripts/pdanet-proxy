#!/bin/bash
# PDANet+ Proxy — routes all TCP traffic through PDANet+ HTTP proxy
# Supports WiFi hotspot (primary) and USB tether (fallback)
# Uses redsocks to transparently redirect via iptables
#
# Usage: pdanet-proxy start|stop|status
# Requires: redsocks, root (for iptables)

PROXY_IP="192.168.49.1"
PROXY_PORT="8000"
LOCAL_PORT="12345"
CONF="/tmp/redsocks-pdanet.conf"
PID="/tmp/redsocks-pdanet.pid"

detect_interface() {
    # Check for any interface on PDANet's 192.168.49.0/24 subnet
    # WiFi hotspot (primary) or USB tether (fallback)
    local iface
    iface=$(ip -4 addr show | grep "192\.168\.49\." | awk '{print $NF}')
    if [ -n "$iface" ]; then
        echo "$iface"
        return 0
    fi
    return 1
}

check_reachable() {
    # Verify the proxy is actually reachable before starting
    if ping -c 1 -W 2 "$PROXY_IP" >/dev/null 2>&1; then
        return 0
    fi
    return 1
}

start_proxy() {
    # Check redsocks is installed
    if ! command -v redsocks >/dev/null 2>&1; then
        echo "ERROR: redsocks not installed. Run: sudo apt install redsocks"
        exit 1
    fi

    # Detect PDANet interface (WiFi or USB)
    local iface
    iface=$(detect_interface)
    if [ -z "$iface" ]; then
        echo "ERROR: No PDANet interface found (no interface on 192.168.49.0/24)"
        echo "Connect to PDANet WiFi hotspot or plug in USB tether first."
        exit 1
    fi
    echo "Detected PDANet interface: $iface"

    # Verify proxy is reachable
    if ! check_reachable; then
        echo "ERROR: $PROXY_IP not reachable on $iface"
        echo "Is PDANet+ running on your phone?"
        exit 1
    fi

    # Kill stale redsocks if PID file exists
    if [ -f "$PID" ]; then
        kill "$(cat "$PID")" 2>/dev/null
        rm -f "$PID"
    fi

    # Write redsocks config
    cat > "$CONF" <<EOF
base {
    log_debug = off;
    log_info = off;
    daemon = on;
    redirector = iptables;
}
redsocks {
    local_ip = 127.0.0.1;
    local_port = $LOCAL_PORT;
    ip = $PROXY_IP;
    port = $PROXY_PORT;
    type = http-connect;
}
EOF

    # Start redsocks
    redsocks -c "$CONF" -p "$PID"
    if [ $? -ne 0 ]; then
        echo "ERROR: redsocks failed to start"
        rm -f "$CONF"
        exit 1
    fi

    # Create iptables chain
    iptables -t nat -N REDSOCKS 2>/dev/null

    # Skip local/private/VPN addresses (don't proxy LAN or Tailscale traffic)
    iptables -t nat -A REDSOCKS -d 0.0.0.0/8 -j RETURN
    iptables -t nat -A REDSOCKS -d 10.0.0.0/8 -j RETURN
    iptables -t nat -A REDSOCKS -d 100.64.0.0/10 -j RETURN  # Tailscale CGNAT
    iptables -t nat -A REDSOCKS -d 127.0.0.0/8 -j RETURN
    iptables -t nat -A REDSOCKS -d 169.254.0.0/16 -j RETURN
    iptables -t nat -A REDSOCKS -d 172.16.0.0/12 -j RETURN
    iptables -t nat -A REDSOCKS -d 192.168.0.0/16 -j RETURN
    iptables -t nat -A REDSOCKS -d 224.0.0.0/4 -j RETURN
    iptables -t nat -A REDSOCKS -d 240.0.0.0/4 -j RETURN

    # Send everything else to redsocks
    iptables -t nat -A REDSOCKS -p tcp -j REDIRECT --to-ports "$LOCAL_PORT"

    # Activate: hook into OUTPUT chain
    iptables -t nat -A OUTPUT -p tcp -j REDSOCKS

    echo "PDANet+ proxy started ($PROXY_IP:$PROXY_PORT via $iface)"
}

stop_proxy() {
    # Remove iptables rules
    iptables -t nat -D OUTPUT -p tcp -j REDSOCKS 2>/dev/null
    iptables -t nat -F REDSOCKS 2>/dev/null
    iptables -t nat -X REDSOCKS 2>/dev/null

    # Kill redsocks
    if [ -f "$PID" ]; then
        kill "$(cat "$PID")" 2>/dev/null
        rm -f "$PID"
    fi
    rm -f "$CONF"

    echo "PDANet+ proxy stopped"
}

check_status() {
    # No root needed — check PID file and /proc (readable by any user)
    if [ -f "$PID" ]; then
        local pid
        pid=$(cat "$PID" 2>/dev/null)
        if [ -n "$pid" ] && [ -d "/proc/$pid" ]; then
            local iface
            iface=$(detect_interface)
            echo "running (${iface:-unknown interface})"
            exit 0
        else
            # Stale PID file — process died
            rm -f "$PID" 2>/dev/null
        fi
    fi
    echo "stopped"
    exit 1
}

case "$1" in
    start)  start_proxy ;;
    stop)   stop_proxy ;;
    status) check_status ;;
    *)      echo "Usage: pdanet-proxy start|stop|status"; exit 1 ;;
esac
